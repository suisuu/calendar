<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ³å£°ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç™»éŒ²ã‚¢ãƒ—ãƒª</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        function VoiceCalendarApp() {
            const [inputText, setInputText] = useState('');
            const [parsedEvents, setParsedEvents] = useState([]);
            const [isListening, setIsListening] = useState(false);
            const [isProcessing, setIsProcessing] = useState(false);
            const [autoAddMode, setAutoAddMode] = useState(true);
            const [speechSupported, setSpeechSupported] = useState(false);
            const recognitionRef = useRef(null);

            useEffect(() => {
                // éŸ³å£°èªè­˜ã®ã‚µãƒãƒ¼ãƒˆç¢ºèª
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    setSpeechSupported(true);
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    recognitionRef.current = new SpeechRecognition();
                    
                    const recognition = recognitionRef.current;
                    recognition.continuous = false;
                    recognition.interimResults = false;
                    recognition.lang = 'ja-JP';
                    
                    recognition.onstart = () => {
                        setIsListening(true);
                        setIsProcessing(false);
                    };
                    
                    recognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        setInputText(transcript);
                        setIsListening(false);
                        setIsProcessing(true);
                        
                        // éŸ³å£°å…¥åŠ›å¾Œè‡ªå‹•ã§è§£æ
                        setTimeout(() => {
                            handleParse(transcript);
                            setIsProcessing(false);
                        }, 500);
                    };
                    
                    recognition.onerror = (event) => {
                        console.error('éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼:', event.error);
                        setIsListening(false);
                        setIsProcessing(false);
                    };
                    
                    recognition.onend = () => {
                        setIsListening(false);
                    };
                }
            }, []);

            // è‡ªç„¶è¨€èªè§£æé–¢æ•°
            const parseNaturalLanguage = (text) => {
                const now = new Date();
                
                // æ™‚é–“ã®ãƒ‘ã‚¿ãƒ¼ãƒ³
                const timePatterns = [
                    /(\d{1,2}):(\d{2})/g,
                    /(\d{1,2})æ™‚(?:(\d{2})åˆ†)?/g,
                    /åˆå‰(\d{1,2})æ™‚/g,
                    /åˆå¾Œ(\d{1,2})æ™‚/g
                ];

                // æ—¥ä»˜ã®ãƒ‘ã‚¿ãƒ¼ãƒ³
                const datePatterns = [
                    { pattern: /ä»Šæ—¥/, offset: 0 },
                    { pattern: /æ˜æ—¥/, offset: 1 },
                    { pattern: /æ˜å¾Œæ—¥/, offset: 2 },
                    { pattern: /æ¥é€±æœˆæ›œ/, offset: getNextWeekday(1) },
                    { pattern: /æ¥é€±ç«æ›œ/, offset: getNextWeekday(2) },
                    { pattern: /æ¥é€±æ°´æ›œ/, offset: getNextWeekday(3) },
                    { pattern: /æ¥é€±æœ¨æ›œ/, offset: getNextWeekday(4) },
                    { pattern: /æ¥é€±é‡‘æ›œ/, offset: getNextWeekday(5) },
                    { pattern: /æ¥é€±åœŸæ›œ/, offset: getNextWeekday(6) },
                    { pattern: /æ¥é€±æ—¥æ›œ/, offset: getNextWeekday(0) },
                    { pattern: /(\d{1,2})æœˆ(\d{1,2})æ—¥/, custom: true }
                ];

                // æœŸé–“ã®ãƒ‘ã‚¿ãƒ¼ãƒ³
                const durationPatterns = [
                    /(\d+)æ™‚é–“/,
                    /(\d+)åˆ†/,
                    /1æ™‚é–“/,
                    /30åˆ†/,
                    /2æ™‚é–“/
                ];

                function getNextWeekday(targetDay) {
                    const today = now.getDay();
                    const daysUntilNext = (7 - today + targetDay) % 7;
                    return daysUntilNext === 0 ? 7 : daysUntilNext;
                }

                // æ™‚é–“ã‚’æŠ½å‡º
                let startTime = null;
                for (const pattern of timePatterns) {
                    const match = text.match(pattern);
                    if (match) {
                        if (pattern.source.includes('åˆå¾Œ') && match[1]) {
                            const hour = parseInt(match[1]) + (parseInt(match[1]) === 12 ? 0 : 12);
                            startTime = `${hour.toString().padStart(2, '0')}:00`;
                        } else if (pattern.source.includes('åˆå‰') && match[1]) {
                            const hour = parseInt(match[1]) === 12 ? 0 : parseInt(match[1]);
                            startTime = `${hour.toString().padStart(2, '0')}:00`;
                        } else if (match[1] && match[2]) {
                            startTime = `${match[1].padStart(2, '0')}:${match[2]}`;
                        } else if (match[1]) {
                            startTime = `${match[1].padStart(2, '0')}:00`;
                        }
                        break;
                    }
                }

                // æ—¥ä»˜ã‚’æŠ½å‡º
                let eventDate = new Date(now);
                for (const datePattern of datePatterns) {
                    if (datePattern.custom) {
                        const match = text.match(datePattern.pattern);
                        if (match) {
                            eventDate = new Date(now.getFullYear(), parseInt(match[1]) - 1, parseInt(match[2]));
                            break;
                        }
                    } else if (datePattern.pattern.test(text)) {
                        eventDate = new Date(now);
                        eventDate.setDate(now.getDate() + datePattern.offset);
                        break;
                    }
                }

                // æœŸé–“ã‚’æŠ½å‡º
                let duration = 60; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ1æ™‚é–“
                for (const pattern of durationPatterns) {
                    const match = text.match(pattern);
                    if (match) {
                        if (pattern.source.includes('æ™‚é–“')) {
                            duration = parseInt(match[1]) * 60;
                        } else if (pattern.source.includes('åˆ†')) {
                            duration = parseInt(match[1]);
                        } else if (pattern.source === '1æ™‚é–“') {
                            duration = 60;
                        } else if (pattern.source === '30åˆ†') {
                            duration = 30;
                        } else if (pattern.source === '2æ™‚é–“') {
                            duration = 120;
                        }
                        break;
                    }
                }

                // ã‚¿ã‚¤ãƒˆãƒ«ã‚’æŠ½å‡ºï¼ˆæ™‚é–“ã‚„æ—¥ä»˜ã‚’é™¤ã„ãŸéƒ¨åˆ†ï¼‰
                let title = text;
                title = title.replace(/(\d{1,2}):(\d{2})/g, '');
                title = title.replace(/(\d{1,2})æ™‚(?:(\d{2})åˆ†)?/g, '');
                title = title.replace(/åˆå‰(\d{1,2})æ™‚/g, '');
                title = title.replace(/åˆå¾Œ(\d{1,2})æ™‚/g, '');
                title = title.replace(/ä»Šæ—¥|æ˜æ—¥|æ˜å¾Œæ—¥|æ¥é€±[æœˆç«æ°´æœ¨é‡‘åœŸæ—¥]æ›œ/g, '');
                title = title.replace(/(\d{1,2})æœˆ(\d{1,2})æ—¥/g, '');
                title = title.replace(/(\d+)æ™‚é–“|(\d+)åˆ†|1æ™‚é–“|30åˆ†|2æ™‚é–“/g, '');
                title = title.replace(/ã‹ã‚‰|ã¾ã§|ã®é–“/g, '');
                title = title.trim();

                if (!title) {
                    title = 'æ–°ã—ã„äºˆå®š';
                }

                return {
                    title,
                    date: eventDate,
                    startTime: startTime || '09:00',
                    duration,
                    originalText: text
                };
            };

            const handleParse = (text = inputText) => {
                if (!text.trim()) return;
                
                const parsed = parseNaturalLanguage(text);
                const newEvent = { ...parsed, id: Date.now() };
                setParsedEvents(prev => [...prev, newEvent]);
                
                // è‡ªå‹•è¿½åŠ ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€å³åº§ã«Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’é–‹ã
                if (autoAddMode) {
                    setTimeout(() => {
                        openGoogleCalendar(newEvent);
                    }, 1000);
                }
                
                setInputText('');
            };

            const startListening = () => {
                if (recognitionRef.current && speechSupported) {
                    recognitionRef.current.start();
                }
            };

            const stopListening = () => {
                if (recognitionRef.current && isListening) {
                    recognitionRef.current.stop();
                }
            };

            const generateGoogleCalendarUrl = (event) => {
                const startDate = new Date(event.date);
                const [hours, minutes] = event.startTime.split(':');
                startDate.setHours(parseInt(hours), parseInt(minutes), 0, 0);
                
                const endDate = new Date(startDate);
                endDate.setMinutes(endDate.getMinutes() + event.duration);

                const formatDateTime = (date) => {
                    return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
                };

                const params = new URLSearchParams({
                    action: 'TEMPLATE',
                    text: event.title,
                    dates: `${formatDateTime(startDate)}/${formatDateTime(endDate)}`,
                    details: `éŸ³å£°å…¥åŠ›: ${event.originalText}`
                });

                return `https://calendar.google.com/calendar/render?${params.toString()}`;
            };

            const openGoogleCalendar = (event) => {
                const url = generateGoogleCalendarUrl(event);
                window.open(url, '_blank');
            };

            const formatDateTime = (event) => {
                const date = new Date(event.date);
                const dateStr = date.toLocaleDateString('ja-JP', {
                    month: 'long',
                    day: 'numeric',
                    weekday: 'short'
                });
                
                const startDate = new Date(event.date);
                const [hours, minutes] = event.startTime.split(':');
                startDate.setHours(parseInt(hours), parseInt(minutes), 0, 0);
                
                const endDate = new Date(startDate);
                endDate.setMinutes(endDate.getMinutes() + event.duration);
                
                const timeStr = `${event.startTime} - ${endDate.getHours().toString().padStart(2, '0')}:${endDate.getMinutes().toString().padStart(2, '0')}`;
                
                return { dateStr, timeStr };
            };

            const deleteEvent = (id) => {
                setParsedEvents(prev => prev.filter(event => event.id !== id));
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-indigo-50 to-purple-100 p-4">
                    <div className="max-w-4xl mx-auto">
                        {/* Header */}
                        <div className="bg-white rounded-2xl shadow-xl p-6 mb-6">
                            <div className="flex items-center space-x-3 mb-6">
                                <div className="bg-indigo-600 p-3 rounded-xl">
                                    <span className="text-white text-2xl">ğŸ¤</span>
                                </div>
                                <div>
                                    <h1 className="text-3xl font-bold text-gray-900">éŸ³å£°ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h1>
                                    <p className="text-gray-600">è©±ã™ã ã‘ã§äºˆå®šã‚’ç™»éŒ²</p>
                                </div>
                            </div>

                            {/* Voice Input Section */}
                            <div className="space-y-4">
                                {!speechSupported && (
                                    <div className="bg-yellow-50 border border-yellow-200 rounded-xl p-4">
                                        <p className="text-yellow-800">
                                            ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°èªè­˜ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚Chromeã€Edgeã€Safariã‚’ãŠè©¦ã—ãã ã•ã„ã€‚
                                        </p>
                                    </div>
                                )}

                                {/* Auto-add toggle */}
                                <div className="flex items-center justify-between bg-gray-50 rounded-xl p-4">
                                    <div>
                                        <h3 className="font-semibold text-gray-800">è‡ªå‹•ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¿½åŠ </h3>
                                        <p className="text-sm text-gray-600">éŸ³å£°å…¥åŠ›å¾Œã«è‡ªå‹•ã§Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’é–‹ã</p>
                                    </div>
                                    <button
                                        onClick={() => setAutoAddMode(!autoAddMode)}
                                        className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${
                                            autoAddMode ? 'bg-indigo-600' : 'bg-gray-300'
                                        }`}
                                    >
                                        <span
                                            className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${
                                                autoAddMode ? 'translate-x-6' : 'translate-x-1'
                                            }`}
                                        />
                                    </button>
                                </div>

                                {/* Voice Input Button */}
                                <div className="text-center">
                                    <button
                                        onClick={isListening ? stopListening : startListening}
                                        disabled={!speechSupported || isProcessing}
                                        className={`inline-flex items-center justify-center w-24 h-24 rounded-full transition-all duration-300 transform ${
                                            isListening
                                                ? 'bg-red-500 hover:bg-red-600 scale-110 shadow-2xl'
                                                : isProcessing
                                                ? 'bg-yellow-500 animate-pulse'
                                                : 'bg-indigo-600 hover:bg-indigo-700 hover:scale-105 shadow-xl'
                                        } ${!speechSupported ? 'opacity-50 cursor-not-allowed' : ''}`}
                                    >
                                        {isProcessing ? (
                                            <div className="w-8 h-8 border-4 border-white border-t-transparent rounded-full animate-spin"></div>
                                        ) : (
                                            <span className="text-white text-3xl">
                                                {isListening ? 'ğŸ”´' : 'ğŸ¤'}
                                            </span>
                                        )}
                                    </button>
                                    <p className="mt-4 text-lg font-semibold text-gray-700">
                                        {isProcessing ? 'éŸ³å£°ã‚’è§£æä¸­...' : isListening ? 'è©±ã—ã¦ãã ã•ã„' : 'ãƒã‚¤ã‚¯ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦è©±ã™'}
                                    </p>
                                </div>

                                {/* Current Input Display */}
                                {inputText && (
                                    <div className="bg-blue-50 border border-blue-200 rounded-xl p-4">
                                        <p className="text-blue-800">
                                            <strong>èªè­˜ã—ãŸéŸ³å£°:</strong> "{inputText}"
                                        </p>
                                    </div>
                                )}

                                {/* Manual Input Fallback */}
                                <div className="border-t pt-4">
                                    <label className="block text-sm font-semibold text-gray-700 mb-2">
                                        æ‰‹å‹•å…¥åŠ›ï¼ˆéŸ³å£°èªè­˜ãŒä½¿ãˆãªã„å ´åˆï¼‰
                                    </label>
                                    <div className="flex space-x-3">
                                        <input
                                            type="text"
                                            value={inputText}
                                            onChange={(e) => setInputText(e.target.value)}
                                            onKeyPress={(e) => e.key === 'Enter' && handleParse()}
                                            className="flex-1 px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all duration-200"
                                            placeholder="ä¾‹: æ¥é€±æ°´æ›œ13:00ã‹ã‚‰1æ™‚é–“ä¼šè­°"
                                        />
                                        <button
                                            onClick={() => handleParse()}
                                            className="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-xl transition-all duration-200"
                                        >
                                            è§£æ
                                        </button>
                                    </div>
                                </div>

                                {/* Examples */}
                                <div className="bg-gray-50 p-4 rounded-xl">
                                    <p className="text-sm font-semibold text-gray-700 mb-2">ğŸ’¡ éŸ³å£°å…¥åŠ›ä¾‹:</p>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm text-gray-600">
                                        <div>â€¢ æ˜æ—¥15:00ã‹ã‚‰2æ™‚é–“ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°</div>
                                        <div>â€¢ æ¥é€±é‡‘æ›œ10:30ã‹ã‚‰30åˆ†é¢è«‡</div>
                                        <div>â€¢ 12æœˆ25æ—¥18:00ã‹ã‚‰ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼</div>
                                        <div>â€¢ ä»Šæ—¥åˆå¾Œ2æ™‚ã‹ã‚‰ä¼šè­°</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Events List */}
                        <div className="space-y-4">
                            {parsedEvents.length === 0 ? (
                                <div className="bg-white rounded-2xl shadow-xl p-12 text-center">
                                    <span className="text-6xl mb-4 block">ğŸ¤</span>
                                    <h3 className="text-xl font-semibold text-gray-600 mb-2">éŸ³å£°ã§äºˆå®šã‚’è¿½åŠ </h3>
                                    <p className="text-gray-500">ãƒã‚¤ã‚¯ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã€Œæ˜æ—¥15æ™‚ã‹ã‚‰ä¼šè­°ã€ã®ã‚ˆã†ã«è©±ã—ã¦ãã ã•ã„</p>
                                </div>
                            ) : (
                                parsedEvents.map((event) => {
                                    const { dateStr, timeStr } = formatDateTime(event);
                                    
                                    return (
                                        <div key={event.id} className="bg-white rounded-2xl shadow-xl p-6 hover:shadow-2xl transition-all duration-200">
                                            <div className="flex items-start justify-between mb-4">
                                                <div className="flex-1">
                                                    <h3 className="text-xl font-bold text-gray-900 mb-2">{event.title}</h3>
                                                    <div className="flex items-center space-x-4 text-gray-600 mb-3">
                                                        <div className="flex items-center space-x-2">
                                                            <span>ğŸ“…</span>
                                                            <span>{dateStr}</span>
                                                        </div>
                                                        <div className="flex items-center space-x-2">
                                                            <span>ğŸ•</span>
                                                            <span>{timeStr}</span>
                                                        </div>
                                                    </div>
                                                    <p className="text-sm text-gray-500 bg-gray-50 p-2 rounded-lg">
                                                        éŸ³å£°å…¥åŠ›: "{event.originalText}"
                                                    </p>
                                                </div>
                                                <div className="flex space-x-2 ml-4">
                                                    <button
                                                        onClick={() => openGoogleCalendar(event)}
                                                        className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors duration-200 flex items-center space-x-1"
                                                    >
                                                        <span>ğŸ”—</span>
                                                        <span className="hidden sm:inline">è¿½åŠ </span>
                                                    </button>
                                                    <button
                                                        onClick={() => deleteEvent(event.id)}
                                                        className="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors duration-200"
                                                    >
                                                        ğŸ—‘ï¸
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(React.createElement(VoiceCalendarApp), document.getElementById('root'));
    </script>
</body>
</html>