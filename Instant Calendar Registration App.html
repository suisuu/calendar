<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>音声カレンダー登録アプリ</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide-react/0.263.1/lucide-react.umd.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;
        const { Calendar, Clock, Mic, MicOff, ExternalLink, Trash2 } = lucide;

        function VoiceCalendarApp() {
            const [inputText, setInputText] = useState('');
            const [parsedEvents, setParsedEvents] = useState([]);
            const [isListening, setIsListening] = useState(false);
            const [isProcessing, setIsProcessing] = useState(false);
            const [autoAddMode, setAutoAddMode] = useState(true);
            const [speechSupported, setSpeechSupported] = useState(false);
            const recognitionRef = useRef(null);

            useEffect(() => {
                // 音声認識のサポート確認
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    setSpeechSupported(true);
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    recognitionRef.current = new SpeechRecognition();
                    
                    const recognition = recognitionRef.current;
                    recognition.continuous = false;
                    recognition.interimResults = false;
                    recognition.lang = 'ja-JP';
                    
                    recognition.onstart = () => {
                        setIsListening(true);
                        setIsProcessing(false);
                    };
                    
                    recognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        setInputText(transcript);
                        setIsListening(false);
                        setIsProcessing(true);
                        
                        // 音声入力後自動で解析
                        setTimeout(() => {
                            handleParse(transcript);
                            setIsProcessing(false);
                        }, 500);
                    };
                    
                    recognition.onerror = (event) => {
                        console.error('音声認識エラー:', event.error);
                        setIsListening(false);
                        setIsProcessing(false);
                    };
                    
                    recognition.onend = () => {
                        setIsListening(false);
                    };
                }
            }, []);

            // 自然言語解析関数
            const parseNaturalLanguage = (text) => {
                const now = new Date();
                
                // 時間のパターン
                const timePatterns = [
                    /(\d{1,2}):(\d{2})/g,
                    /(\d{1,2})時(?:(\d{2})分)?/g,
                    /午前(\d{1,2})時/g,
                    /午後(\d{1,2})時/g
                ];

                // 日付のパターン
                const datePatterns = [
                    { pattern: /今日/, offset: 0 },
                    { pattern: /明日/, offset: 1 },
                    { pattern: /明後日/, offset: 2 },
                    { pattern: /来週月曜/, offset: getNextWeekday(1) },
                    { pattern: /来週火曜/, offset: getNextWeekday(2) },
                    { pattern: /来週水曜/, offset: getNextWeekday(3) },
                    { pattern: /来週木曜/, offset: getNextWeekday(4) },
                    { pattern: /来週金曜/, offset: getNextWeekday(5) },
                    { pattern: /来週土曜/, offset: getNextWeekday(6) },
                    { pattern: /来週日曜/, offset: getNextWeekday(0) },
                    { pattern: /(\d{1,2})月(\d{1,2})日/, custom: true }
                ];

                // 期間のパターン
                const durationPatterns = [
                    /(\d+)時間/,
                    /(\d+)分/,
                    /1時間/,
                    /30分/,
                    /2時間/
                ];

                function getNextWeekday(targetDay) {
                    const today = now.getDay();
                    const daysUntilNext = (7 - today + targetDay) % 7;
                    return daysUntilNext === 0 ? 7 : daysUntilNext;
                }

                // 時間を抽出
                let startTime = null;
                for (const pattern of timePatterns) {
                    const match = text.match(pattern);
                    if (match) {
                        if (pattern.source.includes('午後') && match[1]) {
                            const hour = parseInt(match[1]) + (parseInt(match[1]) === 12 ? 0 : 12);
                            startTime = `${hour.toString().padStart(2, '0')}:00`;
                        } else if (pattern.source.includes('午前') && match[1]) {
                            const hour = parseInt(match[1]) === 12 ? 0 : parseInt(match[1]);
                            startTime = `${hour.toString().padStart(2, '0')}:00`;
                        } else if (match[1] && match[2]) {
                            startTime = `${match[1].padStart(2, '0')}:${match[2]}`;
                        } else if (match[1]) {
                            startTime = `${match[1].padStart(2, '0')}:00`;
                        }
                        break;
                    }
                }

                // 日付を抽出
                let eventDate = new Date(now);
                for (const datePattern of datePatterns) {
                    if (datePattern.custom) {
                        const match = text.match(datePattern.pattern);
                        if (match) {
                            eventDate = new Date(now.getFullYear(), parseInt(match[1]) - 1, parseInt(match[2]));
                            break;
                        }
                    } else if (datePattern.pattern.test(text)) {
                        eventDate = new Date(now);
                        eventDate.setDate(now.getDate() + datePattern.offset);
                        break;
                    }
                }

                // 期間を抽出
                let duration = 60; // デフォルト1時間
                for (const pattern of durationPatterns) {
                    const match = text.match(pattern);
                    if (match) {
                        if (pattern.source.includes('時間')) {
                            duration = parseInt(match[1]) * 60;
                        } else if (pattern.source.includes('分')) {
                            duration = parseInt(match[1]);
                        } else if (pattern.source === '1時間') {
                            duration = 60;
                        } else if (pattern.source === '30分') {
                            duration = 30;
                        } else if (pattern.source === '2時間') {
                            duration = 120;
                        }
                        break;
                    }
                }

                // タイトルを抽出（時間や日付を除いた部分）
                let title = text;
                title = title.replace(/(\d{1,2}):(\d{2})/g, '');
                title = title.replace(/(\d{1,2})時(?:(\d{2})分)?/g, '');
                title = title.replace(/午前(\d{1,2})時/g, '');
                title = title.replace(/午後(\d{1,2})時/g, '');
                title = title.replace(/今日|明日|明後日|来週[月火水木金土日]曜/g, '');
                title = title.replace(/(\d{1,2})月(\d{1,2})日/g, '');
                title = title.replace(/(\d+)時間|(\d+)分|1時間|30分|2時間/g, '');
                title = title.replace(/から|まで|の間/g, '');
                title = title.trim();

                if (!title) {
                    title = '新しい予定';
                }

                return {
                    title,
                    date: eventDate,
                    startTime: startTime || '09:00',
                    duration,
                    originalText: text
                };
            };

            const handleParse = (text = inputText) => {
                if (!text.trim()) return;
                
                const parsed = parseNaturalLanguage(text);
                const newEvent = { ...parsed, id: Date.now() };
                setParsedEvents(prev => [...prev, newEvent]);
                
                // 自動追加モードの場合、即座にGoogleカレンダーを開く
                if (autoAddMode) {
                    setTimeout(() => {
                        openGoogleCalendar(newEvent);
                    }, 1000);
                }
                
                setInputText('');
            };

            const startListening = () => {
                if (recognitionRef.current && speechSupported) {
                    recognitionRef.current.start();
                }
            };

            const stopListening = () => {
                if (recognitionRef.current && isListening) {
                    recognitionRef.current.stop();
                }
            };

            const generateGoogleCalendarUrl = (event) => {
                const startDate = new Date(event.date);
                const [hours, minutes] = event.startTime.split(':');
                startDate.setHours(parseInt(hours), parseInt(minutes), 0, 0);
                
                const endDate = new Date(startDate);
                endDate.setMinutes(endDate.getMinutes() + event.duration);

                const formatDateTime = (date) => {
                    return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
                };

                const params = new URLSearchParams({
                    action: 'TEMPLATE',
                    text: event.title,
                    dates: `${formatDateTime(startDate)}/${formatDateTime(endDate)}`,
                    details: `音声入力: ${event.originalText}`
                });

                return `https://calendar.google.com/calendar/render?${params.toString()}`;
            };

            const openGoogleCalendar = (event) => {
                const url = generateGoogleCalendarUrl(event);
                window.open(url, '_blank');
            };

            const formatDateTime = (event) => {
                const date = new Date(event.date);
                const dateStr = date.toLocaleDateString('ja-JP', {
                    month: 'long',
                    day: 'numeric',
                    weekday: 'short'
                });
                
                const startDate = new Date(event.date);
                const [hours, minutes] = event.startTime.split(':');
                startDate.setHours(parseInt(hours), parseInt(minutes), 0, 0);
                
                const endDate = new Date(startDate);
                endDate.setMinutes(endDate.getMinutes() + event.duration);
                
                const timeStr = `${event.startTime} - ${endDate.getHours().toString().padStart(2, '0')}:${endDate.getMinutes().toString().padStart(2, '0')}`;
                
                return { dateStr, timeStr };
            };

            const deleteEvent = (id) => {
                setParsedEvents(prev => prev.filter(event => event.id !== id));
            };

            return React.createElement('div', { className: "min-h-screen bg-gradient-to-br from-indigo-50 to-purple-100 p-4" },
                React.createElement('div', { className: "max-w-4xl mx-auto" },
                    // Header
                    React.createElement('div', { className: "bg-white rounded-2xl shadow-xl p-6 mb-6" },
                        React.createElement('div', { className: "flex items-center space-x-3 mb-6" },
                            React.createElement('div', { className: "bg-indigo-600 p-3 rounded-xl" },
                                React.createElement(Mic, { className: "h-8 w-8 text-white" })
                            ),
                            React.createElement('div', null,
                                React.createElement('h1', { className: "text-3xl font-bold text-gray-900" }, "音声カレンダー"),
                                React.createElement('p', { className: "text-gray-600" }, "話すだけで予定を登録")
                            )
                        ),

                        // Voice Input Section
                        React.createElement('div', { className: "space-y-4" },
                            !speechSupported && React.createElement('div', { className: "bg-yellow-50 border border-yellow-200 rounded-xl p-4" },
                                React.createElement('p', { className: "text-yellow-800" },
                                    "このブラウザは音声認識をサポートしていません。Chrome、Edge、Safariをお試しください。"
                                )
                            ),

                            // Auto-add toggle
                            React.createElement('div', { className: "flex items-center justify-between bg-gray-50 rounded-xl p-4" },
                                React.createElement('div', null,
                                    React.createElement('h3', { className: "font-semibold text-gray-800" }, "自動カレンダー追加"),
                                    React.createElement('p', { className: "text-sm text-gray-600" }, "音声入力後に自動でGoogleカレンダーを開く")
                                ),
                                React.createElement('button', {
                                    onClick: () => setAutoAddMode(!autoAddMode),
                                    className: `relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${autoAddMode ? 'bg-indigo-600' : 'bg-gray-300'}`
                                },
                                    React.createElement('span', {
                                        className: `inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${autoAddMode ? 'translate-x-6' : 'translate-x-1'}`
                                    })
                                )
                            ),

                            // Voice Input Button
                            React.createElement('div', { className: "text-center" },
                                React.createElement('button', {
                                    onClick: isListening ? stopListening : startListening,
                                    disabled: !speechSupported || isProcessing,
                                    className: `inline-flex items-center justify-center w-24 h-24 rounded-full transition-all duration-300 transform ${
                                        isListening
                                            ? 'bg-red-500 hover:bg-red-600 scale-110 shadow-2xl'
                                            : isProcessing
                                            ? 'bg-yellow-500 animate-pulse'
                                            : 'bg-indigo-600 hover:bg-indigo-700 hover:scale-105 shadow-xl'
                                    } ${!speechSupported ? 'opacity-50 cursor-not-allowed' : ''}`
                                },
                                    isProcessing ? React.createElement('div', { className: "w-8 h-8 border-4 border-white border-t-transparent rounded-full animate-spin" })
                                        : isListening ? React.createElement(MicOff, { className: "h-10 w-10 text-white" })
                                        : React.createElement(Mic, { className: "h-10 w-10 text-white" })
                                ),
                                React.createElement('p', { className: "mt-4 text-lg font-semibold text-gray-700" },
                                    isProcessing ? '音声を解析中...' : isListening ? '話してください' : 'マイクボタンを押して話す'
                                )
                            ),

                            // Current Input Display
                            inputText && React.createElement('div', { className: "bg-blue-50 border border-blue-200 rounded-xl p-4" },
                                React.createElement('p', { className: "text-blue-800" },
                                    React.createElement('strong', null, "認識した音声:"), ` "${inputText}"`
                                )
                            ),

                            // Manual Input Fallback
                            React.createElement('div', { className: "border-t pt-4" },
                                React.createElement('label', { className: "block text-sm font-semibold text-gray-700 mb-2" },
                                    "手動入力（音声認識が使えない場合）"
                                ),
                                React.createElement('div', { className: "flex space-x-3" },
                                    React.createElement('input', {
                                        type: "text",
                                        value: inputText,
                                        onChange: (e) => setInputText(e.target.value),
                                        onKeyPress: (e) => e.key === 'Enter' && handleParse(),
                                        className: "flex-1 px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all duration-200",
                                        placeholder: "例: 来週水曜13:00から1時間会議"
                                    }),
                                    React.createElement('button', {
                                        onClick: () => handleParse(),
                                        className: "bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-xl transition-all duration-200"
                                    }, "解析")
                                )
                            )
                        )
                    ),

                    // Events List
                    React.createElement('div', { className: "space-y-4" },
                        parsedEvents.length === 0 ? 
                            React.createElement('div', { className: "bg-white rounded-2xl shadow-xl p-12 text-center" },
                                React.createElement(Mic, { className: "h-16 w-16 text-gray-300 mx-auto mb-4" }),
                                React.createElement('h3', { className: "text-xl font-semibold text-gray-600 mb-2" }, "音声で予定を追加"),
                                React.createElement('p', { className: "text-gray-500" }, "マイクボタンを押して「明日15時から会議」のように話してください")
                            )
                        : parsedEvents.map((event) => {
                            const { dateStr, timeStr } = formatDateTime(event);
                            
                            return React.createElement('div', { key: event.id, className: "bg-white rounded-2xl shadow-xl p-6 hover:shadow-2xl transition-all duration-200" },
                                React.createElement('div', { className: "flex items-start justify-between mb-4" },
                                    React.createElement('div', { className: "flex-1" },
                                        React.createElement('h3', { className: "text-xl font-bold text-gray-900 mb-2" }, event.title),
                                        React.createElement('div', { className: "flex items-center space-x-4 text-gray-600 mb-3" },
                                            React.createElement('div', { className: "flex items-center space-x-2" },
                                                React.createElement(Calendar, { className: "h-4 w-4" }),
                                                React.createElement('span', null, dateStr)
                                            ),
                                            React.createElement('div', { className: "flex items-center space-x-2" },
                                                React.createElement(Clock, { className: "h-4 w-4" }),
                                                React.createElement('span', null, timeStr)
                                            )
                                        ),
                                        React.createElement('p', { className: "text-sm text-gray-500 bg-gray-50 p-2 rounded-lg" },
                                            `音声入力: "${event.originalText}"`
                                        )
                                    ),
                                    React.createElement('div', { className: "flex space-x-2 ml-4" },
                                        React.createElement('button', {
                                            onClick: () => openGoogleCalendar(event),
                                            className: "bg-blue-500 hover:bg-blue-600 text-white p-2 rounded-lg transition-colors duration-200 flex items-center space-x-1"
                                        },
                                            React.createElement(ExternalLink, { className: "h-4 w-4" }),
                                            React.createElement('span', { className: "hidden sm:inline" }, "追加")
                                        ),
                                        React.createElement('button', {
                                            onClick: () => deleteEvent(event.id),
                                            className: "bg-red-500 hover:bg-red-600 text-white p-2 rounded-lg transition-colors duration-200"
                                        },
                                            React.createElement(Trash2, { className: "h-4 w-4" })
                                        )
                                    )
                                )
                            );
                        })
                    )
                )
            );
        }

        ReactDOM.render(React.createElement(VoiceCalendarApp), document.getElementById('root'));
    </script>
</body>
</html>